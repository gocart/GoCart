
var archiv={preInit:function(){tinyMCEPopup.requireLangPack();},init:function(){try{window.onerror=function(message,url,line){alert(message+' '+url+' '+line);};if(!FlashDetect.installed||FlashDetect.major<9){$('#main').hide();this.alert('Flash',tinyMCEPopup.getLang('Archiv.ErrorOldFlashVersion')+', <a href="http://get.adobe.com/flashplayer/" title="'+tinyMCEPopup.getLang('Archiv.PleaseUpdateFlashVersion')+'">'+tinyMCEPopup.getLang('Archiv.PleaseUpdateFlashVersion')+'</a>!<br />');}
else{$("#loader").ajaxStart(function(){$(this).show();});$("#loader").ajaxStop(function(){$(this).hide();});this.SettingsFile=tinyMCE.activeEditor.getParam('Archiv_settings_file');this.Connector='php/connector.php';this.CurrentDirectory=null;this.CurrentPath=null;this.DirectoryList=Array();this.ContentList=Array();this.InfoArray=Array();this.BrowserType=tinyMCEPopup.getWindowArg('browserType');this.Parameter=this.timestamp();this.Debug="true";this.SecurityAdd=null;archiv.getSettings();}}
catch(e){this.debug(arguments.callee,e);}},postinit:function(){try{this.Debug=this._debug;this.build_swfupload();this.getTreePopulation();this.getContentPopulation(null,"/");}
catch(e){this.debug(arguments.callee,e);}},getSettings:function(){try{$.post(this.Connector,{get:'settings',settings_file:this.SettingsFile},function(data,textStatus)
{if(textStatus=='success'){try{archiv._path=data.Archiv_path;archiv._files=data.Archiv_files;archiv._image_files=data.Archiv_image_files;archiv._file_size_limit=data.Archiv_file_size_limit;archiv._file_upload_limit=data.Archiv_file_upload_limit;archiv._debug=data.Archiv_debug;archiv.postinit();}
catch(e2){archiv.debug(arguments.callee,e2);}}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorReadingSettingsFile')+" `"+tinyMCE.activeEditor.getParam('Archiv_settings_file'));}},'json');}
catch(e){this.debug(arguments.callee,e);}},timestamp:function(){var now=new Date();var hour=now.getHours();var min=now.getMinutes();var sec=now.getSeconds();return hour+''+min+''+sec;},getTreePopulation:function(){try{$.post(this.Connector,{get:'dirList',settings_file:this.SettingsFile,time:this.Parameter,browser:this.BrowserType},function(data,textStatus){if(textStatus=='success'){archiv.populateTreeView(data);}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorLoadingTree'));}},'json');}
catch(e){this.debug(arguments.callee,e);}},getContentPopulation:function(directoryObj,directoryPath){try{if(directoryObj!==null){this.setCurrentDirectory(directoryObj,directoryPath);}
this.CurrentPath=directoryPath;$.post(this.Connector,{get:'dirContent',settings_file:this.SettingsFile,time:this.Parameter,directoryRoot:this.CurrentPath,browser:this.BrowserType},function(data,textStatus){if(textStatus=='success'){archiv.clearDirectoryContent();if(archiv.CurrentPath!="/"){$("#removeDirectory").css("display","block");}
else{$("#removeDirectory").css("display","none");}
if(data.dircontent.length>0){archiv.populateContentView(data);}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.NoFiles'));}}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorLoadingDirectoryContent'));}},'json');}
catch(e){this.debug(arguments.callee,e);}},setCurrentDirectory:function(Obj,directoryPath){try{if(this.CurrentDirectory!==null){$(this.CurrentDirectory).removeClass("selectedDirectory");}
this.CurrentDirectory=Obj;$(this.CurrentDirectory).addClass("selectedDirectory");this.setCurrentDirectoryLabel(directoryPath);}
catch(e){this.debug(arguments.callee,e);}},populateTreeView:function(content){try{if(content.dirlist!==false&&$(content.dirlist).length>0){this.DirectoryList="<ul id=\"direcotryList\">"+"<li><span href=\"javascript:void(0);\" onclick=\"archiv.getContentPopulation(this,'/');\">/</span>"+"<ul>"+
this.dataToUL(content.dirlist)+"</ul></li>"+"</ul>";}
else{this.DirectoryList="<ul id=\"direcotryList\">"+"<li><span onclick=\"archiv.getContentPopulation(this,'/');\">/</span></li>"+"</ul>";}
this.setDirectoryList(this.DirectoryList);}
catch(e){this.debug(arguments.callee,e);}},dataToUL:function(node,path){try{path=(path)?path:"";var list="";if(typeof(node)!='undefined'){$(node).each(function(i,val){if(typeof(val)=='string'){list+="<li><span onclick=\"archiv.getContentPopulation(this,'"+path+"/"+val+"');\" id=\""+path+"/"+val+"\">"+val+"</span>";}
else{list+="<li><span onclick=\"archiv.getContentPopulation(this,'"+path+"/"+$(val).get(0)+"');\" id=\""+path+"/"+$(val).get(0)+"\">"+$(val).get(0)+"</span>";list+="<ul>"+archiv.dataToUL($(val).get(1),path+"/"+$(val).get(0))+"</ul>";}
list+="</li>";});return list;}}
catch(e){this.debug(arguments.callee,e);}},populateContentView:function(content){try{dirContent="";infoArray=Array();path=(this.CurrentPath!==null)?this.CurrentPath:"/";files=content.dircontent;$(files).each(function(i){dirContent+="<div class=\"file ui-state-default ui-corner-all\">"+"<img src=\""+this.thumb+"\""+"alt=\""+this.name+"\" id=\"file"+i+"\""+"onclick=\"archiv.insertFile('"+path+"','"+this.name+"')\" />"+
this.short_name+"<div class=\"delete\""+"id=\"file"+i+"_delete\""+"title=\""+tinyMCEPopup.getLang('Archiv.FileDelete')+"\""+"onclick=\"archiv.deleteFile('"+this.name+"','"+path+"',this);\"></div>"+"</div>";infoArray[i]=Array("file"+i,"<table><tr><th>"+tinyMCEPopup.getLang('Archiv.FileName')+":</th><td>"+this.name+"</td></tr><tr><th>"+tinyMCEPopup.getLang('Archiv.FileType')+":</th><td>"+this.type+"</td></tr><tr><th>"+tinyMCEPopup.getLang('Archiv.FileSize')+":</th><td>"+this.fileSize+"</td></tr><tr><th>"+tinyMCEPopup.getLang('Archiv.FileDimentions')+":</th><td>"+this.imageSize+"</td></tr></table>");});this.setDirectoryContent(dirContent,infoArray);}
catch(e){this.debug(arguments.callee,e);}},addDirectory:function(directoryName){try{directoryRoot=(this.CurrentPath!==null)?this.CurrentPath:"/";$.post(this.Connector,{doAction:'addDirectory',settings_file:this.SettingsFile,time:this.Parameter,dirName:directoryName,dirRoot:directoryRoot},function(data,textStatus){if(textStatus=='success'){if(data.message=="ok"){archiv.getTreePopulation();archiv.displayError("Directory `"+directoryName+"` added!",2000);}
else{archiv.displayError(data.message,2000);}}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorAddingDirectory'));}},'json');}
catch(e){this.debug(arguments.callee,e);}},setDirectoryList:function(dirList){$("#treeView").html(dirList);var $tree=$("#direcotryList li");var $roots=$tree.find('li');$tree.find('li:last-child > a').addClass('last_dir');$roots.each(function(){if($(this).children('ul').length>0){$(this).addClass('root');}});},askDirectoryName:function(){try{directoryName=this.prompt(tinyMCEPopup.getLang('Archiv.QuestionDirectoryName')+":",this.set_directoryname);}
catch(e){this.debug(arguments.callee,e);}},insertFile:function(thePath,theFile){try{absPath=this._path;thePath=(thePath!=='/')?thePath.substr(1)+'/':'';if(this.BrowserType=="images"){tinyMCEPopup.editor.execCommand('mceInsertContent',false,"<img src=\""+absPath+thePath+theFile+"\" alt=\""+theFile+"\" />");}
else{tinyMCEPopup.editor.execCommand('mceInsertContent',false,"<a href=\""+absPath+thePath+theFile+"\" title=\""+theFile+"\">"+theFile+"</a>");}
tinyMCEPopup.close();}
catch(e){this.debug(arguments.callee,e);}},build_swfupload:function(){try{archiv.plugin_abspath=window.location.href.substring(0,window.location.href.lastIndexOf("/")+1);}
catch(e){this.debug(arguments.callee,e);}
try{if(!this.swfu){this.swfu=new SWFUpload({upload_url:archiv.plugin_abspath+archiv.Connector,post_params:{doAction:'addFile',settings_file:archiv.SettingsFile,path:$('#currentDirectory').text(),browser:archiv.BrowserType},file_size_limit:archiv._file_size_limit,file_types:(archiv.BrowserType=="images")?archiv._image_files:archiv._files,file_types_description:(archiv.BrowserType=="images")?"Images":"Files",file_upload_limit:archiv._file_upload_limit,file_queue_limit:"0",file_queue_error_handler:fileQueueError,file_dialog_complete_handler:fileDialogComplete,upload_progress_handler:uploadProgress,upload_error_handler:uploadError,upload_success_handler:uploadSuccess,upload_complete_handler:uploadComplete,button_image_url:"",button_placeholder_id:"spanButtonPlaceholder",button_width:180,button_height:22,button_text:'<span class="button">Select Files</span>',button_text_style:'.button { font-family:Verdana, Arial, Helvetica, sans-serif; font-size: 12pt; text-align:right; } .buttonSmall { font-size: 10pt; }',button_text_top_padding:2,button_text_left_padding:0,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,flash_url:archiv.plugin_abspath+"swf/swfupload.swf",custom_settings:{upload_target:"divFileProgressContainer"},debug:false});}
else{this.swfu.setPostParams({doAction:'addFile',settings_file:archiv.SettingsFile,path:$('#currentDirectory').text(),browser:archiv.BrowserType});}}
catch(ee){this.debug(arguments.callee,ee);}},setCurrentDirectoryLabel:function(dirName){try{$('#currentDirectory').text(dirName);this.build_swfupload();}
catch(e){this.debug(arguments.callee,e);}},setDirectoryContent:function(dirContent,infoArray){try{tipTop="<div class=\"title\">"+tinyMCEPopup.getLang('Archiv.FileInfo')+"</div>";tipBottom="<div class=\"bottom\">"+tinyMCEPopup.getLang('Archiv.FileClickToAdd')+"</div>";$("#fileHolder").html(dirContent);ids='';for(i=0;i<infoArray.length;i++){this.InfoArray[infoArray[i][0]]=infoArray[i][1];ids=(ids==='')?"#"+infoArray[i][0]:ids+','+"#"+infoArray[i][0];}
$(ids).mouseenter(function(){$('#tooltip').slideUp(100).html(tipTop+"<div class=\"content\">"+archiv.InfoArray[this.id]+"</div>"+tipBottom).slideDown('fast',function(){$(ids).mouseout(function(){$('#tooltip').slideUp(100);});});});}
catch(e){this.debug(arguments.callee,e);}},clearDirectoryContent:function(){try{$("#fileHolder").html("");this.hideError();}
catch(e){this.debug(arguments.callee,e);}},deleteFile:function(fileName,path,obj){try{$('body').append('<div id="dialog">'+tinyMCEPopup.getLang('Archiv.ConfirmDeleteFile')+' `'+fileName+'`?'+'</div>');$('#dialog').dialog({bgiframe:true,buttons:{"Ok":function(){$.post(archiv.Connector,{doAction:'deleteFile',settings_file:archiv.SettingsFile,time:archiv.Parameter,fileName:fileName,fileRoot:path},function(data,textStatus){if(textStatus=='success'){if(data.message=="ok"){$(obj).parent().hide('slow');archiv.displayError(tinyMCEPopup.getLang('Archiv.FileDeleted')+": `"+fileName+"`!",5000);}
else{archiv.displayError(data.message);}}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorDeletingFile'));}},'json');$(this).dialog("close");},Cancel:function(){$(this).dialog("close");}},modal:true,resizable:false,width:'auto',title:tinyMCEPopup.getLang('Archiv.FileDelete'),close:function(){$(this).dialog('destroy').remove();}});}
catch(e){this.debug(arguments.callee,e);}},deleteDirectory:function(path){try{$('body').append('<div id="dialog">'+tinyMCEPopup.getLang('Archiv.ConfirmDeleteDirectory')+' `'+path+'`?'+'</div>');$('#dialog').dialog({bgiframe:true,buttons:{"Ok":function(){$.post(archiv.Connector,{doAction:'deleteDirectory',settings_file:archiv.SettingsFile,time:archiv.Parameter,fileRoot:path},function(data,textStatus){if(textStatus=='success'){if(data.message=="ok"){archiv.getTreePopulation();archiv.displayError(tinyMCEPopup.getLang('Archiv.DirectoryDeleted')+": `"+path+"`!",5000);dirs=path.split('/');dirs.pop();if(dirs.length>1){path=dirs.join('/');}
else{path='/';}
archiv.setCurrentDirectoryLabel(path);archiv.getContentPopulation(null,path);}
else{archiv.displayError(data.message);}}
else{archiv.displayError(tinyMCEPopup.getLang('Archiv.ErrorDeletingDirectory'));}},'json');$(this).dialog("close");},Cancel:function(){$(this).dialog("close");}},modal:true,resizable:false,width:'auto',title:tinyMCEPopup.getLang('Archiv.FileDelete'),close:function(){$(this).dialog('destroy').remove();}});}
catch(e){this.debug(arguments.callee,e);}},displayError:function(errorMsg,displayTime){$('#error').html(errorMsg);$('#error').fadeIn('slow',function(){if(displayTime!==null){setTimeout(function(){archiv.hideError();},displayTime);}});},hideError:function(){$('#error').fadeOut('fast');},debug:function(callerFunction,message){if(this.Debug=="true"){this.alert('ERROR',message.message.replace("\r","<br />")+"\r\n\r\n FUNCTION:\r\n"+callerFunction);}
else{this.alert('ERROR',tinyMCEPopup.getLang('Archiv.FatalError'));}},prompt:function(text,function_callback,val){this._callback=function_callback;$('body').append('<div id="dialog" ><input type="text" name="edtDirectoryName" id="edtDirectoryName" value="" /></div>');$('#dialog').dialog({bgiframe:true,buttons:{"Ok":function(){el=$(this).find("#edtDirectoryName");if($(el).val().length>0){archiv._callback($(el).val());$(this).dialog("close");}},"Cancel":function(){$(this).dialog("close");}},modal:true,resizable:false,height:130,minHeight:130,title:text,close:function(){$(this).dialog('destroy').remove();}});},alert:function(title,text){$('body').append('<div id="dialog">'+text+'</div>');$('#dialog').dialog({bgiframe:true,buttons:{"Ok":function(){$(this).dialog("close");}},modal:true,resizable:false,width:'auto',title:title,close:function(){$(this).dialog('destroy').remove();}});},set_directoryname:function(directoryName){if(directoryName!==""&&directoryName!==null){this.addDirectory(directoryName);}},startDrag:function(obj){$("body").css('cursor','e-resize');$().bind('mousemove',function(e){archiv.mousePos(e);});$().mouseup(function(){$().unbind();$("body").css('cursor','');});},mousePos:function(e){if(e.pageX>100&&e.pageX<500){if($.boxModel===true){$('#fileTree').css('width',e.pageX-5+'px');$('#splitter').css('left',e.pageX+'px');$('#fileBrowser').css('left',e.pageX+7+'px');}
else{$('#fileTree').css('width',e.pageX-5+'px');$('#splitter').css('left',e.pageX-10+'px');$('#fileBrowser').css('left',e.pageX-5+'px');}}}};archiv.preInit();tinyMCEPopup.onInit.add(archiv.init,archiv);